name: CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                # This tells GitHub to run two versions of this job simultaneously
                project: [Monitor.Api, Monitor.Worker]

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Configure AWS Credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-1

            - name: Login to Amazon ECR
              id: login-ecr
              uses: aws-actions/amazon-ecr-login@v2

            - name: Build and Push to ECR
              env:
                  ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                  # We convert the project name to lowercase for the repo name
                  REPO_NAME: ${{ matrix.project == 'Monitor.Api' && 'monitor-api' || 'monitor-worker' }}
              run: |
                  docker build -t $ECR_REGISTRY/$REPO_NAME:latest ./${{ matrix.project }}
                  docker push $ECR_REGISTRY/$REPO_NAME:latest

    deploy:
        needs: build-and-push # Only runs if both builds succeed
        runs-on: ubuntu-latest
        steps:
            - name: Deploy to EC2 via SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ec2-user
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # Login to ECR on the server
                      aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

                      # Navigate to your deployment folder and restart containers
                      cd ~/app
                      docker compose pull
                      docker compose up -d
